import 'package:flutter/material.dart';
import '../models/routes.dart';
import '../widgets/booking_progress_bar.dart';
import '../widgets/route_selection_widget.dart';
import '../widgets/stops_section                            ),
                      ],
                    ),idget.dart';
import '../widgets/time_selection_widget.dart';
import '../widgets/seat_planning_section_widget.dart';
import '../widgets/seat_availability_info_widget.dart';
import '../widgets/booking_button_widget.dart';
import '../utils/booking_logic.dart';

class TabContentWidget extends StatefulWidget {
  final String userRole;

  const TabContentWidget({
    super.key,
    required this.userRole,
  });

  @override
  TabContentWidgetState createState() => TabContentWidgetState();
}

class TabContentWidgetState extends State<TabContentWidget> {
  RouteInfo? selectedRoute;
  int? originIndex;
  int? destinationIndex;
  List<int> selectedSeats = [];
  bool hasSelectedDateTime = false;
  ScrollController scrollController = ScrollController();

  @override
  Widget build(BuildContext context) {
    // Compute greyed stops using the utility
    List<int> greyedStops = BookingLogic.computeGreyedStops(
      selectedRoute,
      originIndex,
      destinationIndex,
    );

    return Column(
      children: [
        // Fixed progress bar at the top
        BookingProgressBar(
          currentStep: BookingLogic.getCurrentStep(
            selectedRoute,
            originIndex,
            destinationIndex,
            hasSelectedDateTime,
            selectedSeats,
          ),
        ),
        
        // Scrollable content below
        Expanded(
          child: SingleChildScrollView(
            controller: scrollController,
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                // Route selection dropdown
                RouteSelectionWidget(
                  selectedRoute: selectedRoute,
                  onRouteChanged: (value) {
                    if (value != null) {
                      setState(() {
                        selectedRoute = value;
                        originIndex = null;
                        destinationIndex = null;
                        hasSelectedDateTime = false;
                      });
                      // Auto-scroll to position divider at bottom of progress bar
                      Future.delayed(Duration(milliseconds: 300), () {
                        scrollController.animateTo(
                          85.0,
                          duration: Duration(milliseconds: 500),
                          curve: Curves.easeInOut,
                        );
                      });
                    }
                  },
                ),

                // Show route content only when a route is selected
                if (selectedRoute != null)
                  Padding(
                    padding: const EdgeInsets.only(
                      left: 16,
                      right: 16,
                      top: 16,
                    ),
                    child: Stack(
                      children: [
                        // Main content - stops section takes full width
                        Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            // Stop list section
                            StopsSectionWidget(
                              selectedRoute: selectedRoute!,
                              originIndex: originIndex,
                              destinationIndex: destinationIndex,
                              greyedStops: greyedStops,
                              onOriginChanged: (index) {
                                setState(() {
                                  originIndex = index;
                                });
                              },
                              onDestinationChanged: (index) {
                                setState(() {
                                  destinationIndex = index;
                                });
                              },
                              onResetDateTime: () {
                                setState(() {
                                  hasSelectedDateTime = false;
                                });
                              },
                            ),

                            // Divider between stops and car seat layout
                            if (originIndex != null &&
                                destinationIndex != null &&
                                hasSelectedDateTime)
                              Padding(
                                padding: const EdgeInsets.symmetric(
                                  horizontal: 16,
                                  vertical: 12,
                                ),
                                child: Divider(
                                  color: Colors.grey[300],
                                  thickness: 1,
                                  height: 1,
                                ),
                              ),

                            // Car seat layout section
                            if (originIndex != null &&
                                destinationIndex != null &&
                                hasSelectedDateTime)
                              SeatPlanningSectionWidget(
                                userRole: widget.userRole,
                                selectedSeats: selectedSeats,
                                onSeatsSelected: (seats) {
                                  setState(() {
                                    selectedSeats = seats;
                                  });
                                },
                              ),
                          ],
                        ),

                        // Time picker positioned as overlay on the right
                        if (originIndex != null)
                          Positioned(
                            top: 90,
                            right: 0,
                            child: Container(
                              width: 160,
                              child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                // Time picker section
                                TimeSelectionWidget(
                                  selectedRoute: selectedRoute!,
                                  originIndex: originIndex!,
                                  destinationIndex: destinationIndex,
                                  onDateTimeSelected: (bool selected) {
                                    setState(() {
                                      hasSelectedDateTime = selected;
                                    });
                                    // Auto-scroll to seat layout when time selection is completed
                                    if (selected &&
                                        originIndex != null &&
                                        destinationIndex != null) {
                                      Future.delayed(
                                        Duration(milliseconds: 300),
                                        () {
                                          scrollController.animateTo(
                                            300.0,
                                            duration: Duration(milliseconds: 500),
                                            curve: Curves.easeInOut,
                                          );
                                        },
                                      );
                                    }
                                  },
                                ),

                                // Seat availability information card
                                if (destinationIndex != null && hasSelectedDateTime)
                                  SeatAvailabilityInfoWidget(
                                    selectedRoute: selectedRoute!,
                                    originIndex: originIndex!,
                                    destinationIndex: destinationIndex!,
                                    selectedSeats: selectedSeats,
                                    userRole: widget.userRole,
                                  ),
                              ],
                            ),
                          ),
                      ],
                    ),
                  ),

                // Complete Booking button
                if (destinationIndex != null && hasSelectedDateTime)
                  BookingButtonWidget(
                    selectedRoute: selectedRoute,
                    originIndex: originIndex,
                    destinationIndex: destinationIndex,
                    selectedSeats: selectedSeats,
                  ),

                // Fixed height spacer to push dropdown upward by consuming space
                Container(
                  height: MediaQuery.of(context).size.height * 0.8,
                ),
              ],
            ),
          ),
        ),
      ],
    );
  }
}
